# 中山大学数据科学与计算机学院本科生实验报告
## （2018年秋季学期）
| 课程名称 | 手机平台应用开发 |   任课老师   |       郑贵锋       |
| :------: | :--------------: | :----------: | :----------------: |
|   年级   |       16级       | 专业（方向） |      软件工程      |
|   学号   |     163400310     |     姓名     |        陈涛斯敏        |
|   电话   |   15917173057    |    Email     | 2540740154@qq.com |
| 开始日期 |     11月8日      |   完成日期   |      11月15日       |

---

## 一、实验题目
1. 王者荣耀盒子

---

## 二、实现内容
1. 数据获取——使用python的bs4进行脚本编写和数据爬取并存入数据库。
2. 我的英雄界面UI和逻辑实现（tab滑动列表，英雄的增加和删除）。
3. 装备大全界面UI和逻辑实现（tab滑动列表，点击装备获取详细信息）。
4. 英雄详情页面点击装备弹出详细信息。
5. 获取相关信息的数据库代码实现。

---

## 三、实验结果
### (1)实验截图
* 在主页面点击我的英雄进入英雄列表，按照英雄类型进行tab分页：
  ![img1](image/chensm_img1.png)
* 英雄列表页面，点击添加，从未添加列表中选择英雄添加:
  ![img2](image/chensm_img2.png)
* 英雄列表页面长按英雄，删除我喜欢的英雄:
  ![img3](image/chensm_img3.png)
* 在主页面点击装备大全，进入装备页面，按照装备类型进行tab分页，点击装备获取装备详情：
  ![img4](image/chensm_img4.png)
* 在英雄详情页面点击出装中的装备，获取装备详情：
  ![img5](image/chensm_img5.png)


### (2)实验步骤以及关键代码
## **装备大全列表界面**

### 实验步骤
* 实现逻辑部分
* 完善UI部分

### 关键代码
#### 1. 实现页面的tab效果，即触屏滑动切换页面，此处我使用的是ViewPager和TabLayout合并使用的到的效果：
* 首先是activity_equip.xml布局，比较简单，就是上述的那两个控件：
  ```xml
    <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:orientation="vertical"
        xmlns:app="http://schemas.android.com/apk/res-auto">
        <android.support.design.widget.TabLayout
            android:id="@+id/sliding_tabs"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            app:tabTextColor="#FFFFFF"
            android:background="#333333"
            />
        <android.support.v4.view.ViewPager
            android:id="@+id/viewpager"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            />
    </LinearLayout>
  ```
* EquipActivity 将两者合并起来
  ```java
    private ViewPager mViewPager;
    private TabLayout mTabLayout;
    private FragmentManager mFragmentManager;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_equip);

        mTabLayout = findViewById(R.id.sliding_tabs);
        mViewPager = findViewById(R.id.viewpager);
        mFragmentManager = getSupportFragmentManager();
        //为viewpager设置适配器
        mViewPager.setAdapter(new EquipDetailPageAdapter(EquipActivity.this, mFragmentManager));
        // 绑定TabLayout和ViewPager
        mTabLayout.setupWithViewPager(mViewPager);
    }
  ```
* 然后便是适配器EquipDetailPageAdapter，因为其实滑动切换页面是需要多个Fragment来实现的，所以我们需要为这几个Fragment设置布局和逻辑等。但因为我们此处多个Fragment的样式和逻辑是相似的（列表式页面），所以代码可复用,这里的EquipDetailPageAdapter就是来管理多个Fragment的适配器：
  ```java
  public class EquipDetailPageAdapter extends FragmentPagerAdapter {

    private static int PAGE_COUNT;//表示要展示的页面数量
    String[] type = {"攻击", "法术", "防御", "移动", "打野", "辅助"};
    private Context mContext;

    public EquipDetailPageAdapter(Context context, FragmentManager fm) {
        super(fm);
        this.mContext = context;
        PAGE_COUNT = 6;
    }

    @Override
    public Fragment getItem(int position) {
        return EquipInfoFragment.newInstance(position);
    }

    @Override
    public int getCount() {
        return PAGE_COUNT;
    }

    @Override
    public CharSequence getPageTitle(int position) {//设置标题
        if (position < 6)
            return type[position];
        else
            return null;
    }
  }
  ```
* EquipInfoFragment用以根据type（装备类型）生成相应的Fragment，相应的newInstance函数也可以在上面的适配器实现：
  ```java
  public class EquipInfoFragment extends Fragment {
    private static final String ARG_PARAM = "param";
    private int mParam;//用来表示当前需要展示的是哪一页
    public EquipInfoFragment() {
        // Required empty public constructor
    }
    public static EquipInfoFragment newInstance(int param) {
        EquipInfoFragment fragment = new EquipInfoFragment();
        Bundle args = new Bundle();
        args.putInt(ARG_PARAM, param);
        fragment.setArguments(args);
        return fragment;
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        if (getArguments() != null) {
            mParam = getArguments().getInt(ARG_PARAM);
        }
    }
    ...
  ```
* 然后是设置每个页面的gridView，gridView也需要相应的适配器，也就是我们会在Fragment的适配器中对其gridView再进行设置适配器：
  ```java
    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        // Inflate the layout for this fragment
        View view = inflater.inflate(R.layout.equip_list, container, false);
        GridView gridView = view.findViewById(R.id.gridView);

        //根据mParam来判断当前展示的是哪个类型的出装，获取相应的gridView的适配器。
        String[] type = {"攻击", "法术", "防御", "移动", "打野", "辅助"};
        gridView.setAdapter(new EquipListViewAdapter(view.getContext(), type[mParam]));
        gridView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, final View view, int position, long id) {
                ...
            }
        });
        return view;
    }
  ```
#### 2. 装备列表页面列表的实现
* 此处我使用的是gridView，xml页面只是单纯一个FrameLayout包着一个gridView而已：
  ```xml
  <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <GridView
        android:id="@+id/gridView"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:scrollbars="none"
        android:layout_margin="10dp"
        android:numColumns="4"
        android:verticalSpacing="10dp"
        android:horizontalSpacing="10dp"/>

  </FrameLayout>
  ```
* gridView的适配器的实现，这个与之前PersonalProject2中listView的适配器实现相似，此处不过多赘述，此处贴出关键函数getView的实现：
  ```java
    public class EquipListViewAdapter extends BaseAdapter {
        private List<EquipItem> list;
        private Context context;

        public EquipListViewAdapter(Context _context, String type) {
            this.context = _context;
            list = myDB.getInstance().get_equip_list(type);
        }

        @Override
        public View getView(final int i, View view, ViewGroup viewGroup) {
            // 新声明一个View变量和ViewHoleder变量,ViewHolder类在下面定义。
            View convertView ;
            ViewHolder viewHolder;
            // 当view为空时才加载布局，否则，直接修改内容
            if (view == null) {
                // 通过inflate的方法加载布局，context需要在使用这个Adapter的Activity中传入。
                view = LayoutInflater.from(context).inflate(R.layout.equip_item, null);
                viewHolder = new ViewHolder();
                viewHolder.equipName = view.findViewById(R.id.equip_name);
                viewHolder.equipPrice = view.findViewById(R.id.equip_price);
                viewHolder.equipIcon = view.findViewById(R.id.equip_icon);
                view.setTag(viewHolder); // 用setTag方法将处理好的viewHolder放入view中
                convertView = view;
            } else { // 否则，让convertView等于view，然后从中取出ViewHolder即可
                convertView = view;
                viewHolder = (ViewHolder) convertView.getTag();
            }
            final EquipItem equip = list.get(i);
            // 从viewHolder中取出对应的对象，然后赋值给他们
            viewHolder.equipName.setText(equip.getName());
            viewHolder.equipPrice.setText(equip.getPrice());
            viewHolder.equipIcon.setImageBitmap(equip.getImage());
            // 将这个处理好的view返回
            return convertView;
        }

        ...

        private class ViewHolder {
            public TextView equipName;
            public TextView equipPrice;
            public ImageView equipIcon;
        }
    }
  ```
* 初始化时需要从数据库获取相应的类型的装备列表，此处我们看一下myDB中这一块的获取数据的函数：
  ```java
  
  ```
#### 3. 实现现在点击装备时弹出的dialog具有相应布局，显示图片和文字等信息。
* 设置dialog的xml布局文件：
  ```xml
  <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="#00cccccc"
    android:orientation="vertical">

    <ImageView
        android:id="@+id/equip_icon"
        android:shape="rectangle"
        android:layout_width="60dp"
        android:layout_height="60dp"
        android:layout_margin="5dp"
        android:layout_gravity="center_horizontal"/>

    <TextView
        android:id="@+id/equip_name"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_gravity="center_horizontal"
        android:textStyle="bold"
        android:textSize="14sp"/>

    <LinearLayout
        android:layout_gravity="center_horizontal"
        android:padding="5dp"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content">
        <ImageView
            android:src="@drawable/gold_coin"
            android:layout_width="16dp"
            android:layout_height="16dp"
            android:layout_gravity="center_vertical"
            android:layout_marginRight="4dp"/>
        <TextView
            android:id="@+id/equip_price"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_gravity="center_vertical"
            android:textSize="11dp"/>
    </LinearLayout>

    <TextView
        android:id="@+id/equip_detail"
        android:padding="15dp"
        android:background="#F0F0F0"
        android:layout_width="match_parent"
        android:layout_height="wrap_content" />
  </LinearLayout>
  ```
* dialog使用View.inflate来设置对应的xml布局文件：
  ```java
    final AlertDialog.Builder dialog = new AlertDialog.Builder(view.getContext());
    View dialogView = View.inflate(view.getContext(), R.layout.equip_dialog, null);
    String equip_name = ((TextView)view.findViewById(R.id.equip_name)).getText().toString();

    EquipItem equip = myDB.getInstance().get_equip(equip_name);

    TextView Name = dialogView.findViewById(R.id.equip_name);
    Name.setText(equip_name);
    TextView Price = dialogView.findViewById(R.id.equip_price);
    Price.setText((equip.getPrice()));
    ImageView Icon = dialogView.findViewById(R.id.equip_icon);
    Icon.setImageBitmap(equip.getImage());
    TextView Detail = dialogView.findViewById(R.id.equip_detail);
    Detail.setText(equip.getBase_attr()+'\n'+equip.getEquip_skill());

    dialog.setView(dialogView);
    dialog.show();
  ```
## **英雄列表列表界面**

### 实验步骤
* 实现逻辑部分
* 完善UI部分

### (3)实验遇到的困难以及解决思路

---

## 四、实验思考及感想
```

```

---